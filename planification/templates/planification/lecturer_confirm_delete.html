{% extends 'planification/base.html' %}

{% load static %}

{% block title %}Supprimer {{ lecturer.firstname }} {{ lecturer.lastname }} - YSEM{% endblock %}

{% block page_title %}Supprimer l'enseignant{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card-neumorphic">
            <div class="text-center mb-4">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h5 class="text-danger">Confirmer la suppression</h5>
            </div>

            <!-- Lecturer Information -->
            <div class="alert alert-warning">
                <h6 class="alert-heading">
                    <i class="fas fa-chalkboard-teacher me-2"></i>
                    Enseignant à supprimer
                </h6>
                <div class="row">
                    <div class="col-sm-3"><strong>Matricule :</strong></div>
                    <div class="col-sm-9">{{ lecturer.matricule }}</div>
                </div>
                <div class="row">
                    <div class="col-sm-3"><strong>Nom complet :</strong></div>
                    <div class="col-sm-9">{{ lecturer.firstname }} {{ lecturer.lastname }}</div>
                </div>
                <div class="row">
                    <div class="col-sm-3"><strong>Grade :</strong></div>
                    <div class="col-sm-9">{{ lecturer.grade }}</div>
                </div>
                {% if lecturer.email %}
                <div class="row">
                    <div class="col-sm-3"><strong>Email :</strong></div>
                    <div class="col-sm-9">{{ lecturer.email }}</div>
                </div>
                {% endif %}
            </div>

            <!-- Warning about associated sessions -->
            {% if has_sessions %}
            <div class="alert alert-danger">
                <h6 class="alert-heading">
                    <i class="fas fa-ban me-2"></i>
                    Suppression impossible
                </h6>
                <p class="mb-2">
                    Cet enseignant ne peut pas être supprimé car il/elle est assigné(e) à 
                    <strong>{{ sessions_count }}</strong> séance(s) de cours.
                </p>
                <p class="mb-0">
                    <small>
                        Veuillez d'abord supprimer ou réassigner ces séances avant de pouvoir supprimer l'enseignant.
                    </small>
                </p>
            </div>

            <!-- Show some recent sessions -->
            {% if recent_sessions %}
            <div class="mt-3">
                <h6>Quelques séances assignées :</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Cours</th>
                                <th>Salle</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in recent_sessions %}
                            <tr>
                                <td>{{ session.date|date:"d/m/Y" }}</td>
                                <td>{{ session.course.label }}</td>
                                <td>{{ session.classroom.name }}</td>
                                <td>
                                    <span class="badge badge-sm badge-primary">{{ session.get_status_display }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            {% else %}
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>
                    Information
                </h6>
                <p class="mb-0">
                    Cette action est <strong>irréversible</strong>. L'enseignant sera définitivement supprimé du système.
                </p>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'planification:lecturer_detail' matricule=lecturer.matricule %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Retour aux détails
                </a>
                
                {% if not has_sessions %}
                <form method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" onclick="return confirmDeletion()">
                        <i class="fas fa-trash me-2"></i>
                        Confirmer la suppression
                    </button>
                </form>
                {% else %}
                <button type="button" class="btn btn-danger" disabled>
                    <i class="fas fa-ban me-2"></i>
                    Suppression impossible
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Additional Actions -->
{% if has_sessions %}
<div class="row justify-content-center mt-4">
    <div class="col-lg-8">
        <div class="card-neumorphic">
            <h6 class="mb-3">
                <i class="fas fa-lightbulb me-2"></i>
                Actions alternatives
            </h6>
            <div class="d-grid gap-2">
                <a href="{% url 'planification:sessions' %}?lecturer={{ lecturer.matricule }}" class="btn btn-outline-primary">
                    <i class="fas fa-calendar-check me-2"></i>
                    Voir les séances de cet enseignant
                </a>
                <a href="{% url 'planification:lecturer_update' matricule=lecturer.matricule %}" class="btn btn-outline-warning">
                    <i class="fas fa-edit me-2"></i>
                    Modifier les informations de l'enseignant
                </a>
                <button type="button" class="btn btn-outline-info" onclick="showReassignmentHelp()">
                    <i class="fas fa-exchange-alt me-2"></i>
                    Comment réassigner les séances
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Reassignment Help Modal -->
<div class="modal fade" id="reassignmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-question-circle me-2"></i>
                    Comment réassigner les séances
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Pour pouvoir supprimer cet enseignant, vous devez d'abord :</p>
                <ol>
                    <li>Aller dans la section <strong>"Séances de cours"</strong></li>
                    <li>Filtrer par cet enseignant ({{ lecturer.firstname }} {{ lecturer.lastname }})</li>
                    <li>Pour chaque séance :</li>
                    <ul>
                        <li>Soit <strong>supprimer</strong> la séance si elle n'est plus nécessaire</li>
                        <li>Soit <strong>modifier</strong> la séance pour assigner un autre enseignant</li>
                    </ul>
                    <li>Une fois toutes les séances traitées, vous pourrez supprimer l'enseignant</li>
                </ol>
                <div class="alert alert-info mt-3">
                    <small>
                        <i class="fas fa-lightbulb me-1"></i>
                        <strong>Conseil :</strong> Vous pouvez aussi créer un nouvel enseignant de remplacement avant de faire les réassignations.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <a href="{% url 'planification:sessions' %}?lecturer={{ lecturer.matricule }}" class="btn btn-primary">
                    Voir les séances
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmDeletion() {
    return confirm(
        'ATTENTION : Cette action est irréversible !\n\n' +
        'Êtes-vous absolument certain de vouloir supprimer l\'enseignant "{{ lecturer.firstname }} {{ lecturer.lastname }}" ?\n\n' +
        'Toutes ses informations seront définitivement perdues.'
    );
}

function showReassignmentHelp() {
    const modal = new bootstrap.Modal(document.getElementById('reassignmentModal'));
    modal.show();
}

// Add extra confirmation for deletion
document.addEventListener('DOMContentLoaded', function() {
    const deleteForm = document.querySelector('form[method="post"]');
    if (deleteForm) {
        deleteForm.addEventListener('submit', function(e) {
            const confirmed = confirm(
                'DERNIÈRE CONFIRMATION !\n\n' +
                'Vous êtes sur le point de supprimer définitivement l\'enseignant :\n' +
                '{{ lecturer.firstname }} {{ lecturer.lastname }} ({{ lecturer.matricule }})\n\n' +
                'Cette action ne peut pas être annulée.\n\n' +
                'Tapez "SUPPRIMER" pour confirmer.'
            );
            
            if (confirmed) {
                const userInput = prompt('Tapez "SUPPRIMER" pour confirmer la suppression :');
                if (userInput !== 'SUPPRIMER') {
                    e.preventDefault();
                    alert('Suppression annulée. Vous devez taper exactement "SUPPRIMER" pour confirmer.');
                }
            } else {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
