{% extends 'Teaching/base.html' %}
{% load static %}

{% block title %}Statistiques - Enseignement-YSEM{% endblock %}

{% block page_title %}Statistiques{% endblock %}

{% block content %}
<div class="row">
    <!-- Period Selector -->
    <div class="col-12 mb-4">
        <div class="card-neumorphic">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Statistiques de suivi des enseignements
                    </h5>
                </div>
                <div class="col-md-6">
                    <form method="get" id="filter-form">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <select class="form-select p-2" name="academic_year" id="academic_year" onchange="document.getElementById('filter-form').submit();">
                                    {% for year in academic_years %}
                                        <option value="{{ year.id }}" {% if current_year.id == year.id %}selected{% endif %}>
                                            {{ year.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select p-2" name="program" id="program" onchange="document.getElementById('filter-form').submit();">
                                    <option value="">Tous les programmes</option>
                                    {% for program in programs %}
                                        <option value="{{ program.id }}" {% if selected_program and selected_program.id == program.id %}selected{% endif %}>
                                            {{ program.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Key Metrics -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card-neumorphic text-center">
            <div class="mb-3">
                <i class="fas fa-users fa-3x text-dark"></i>
                <!-- <i class="fas fa-book fa-3x text-success"></i> -->
            </div>
            <h3 class="mb-1">{{ kpis.total_lecturers|default:0 }}</h3>
            <p class="text-muted mb-2">Total enseignants</p>
            <div class="d-flex justify-content-center align-items-center">
                <small class="text-muted">dans le système</small>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card-neumorphic text-center">
            <div class="mb-3">
                <i class="fas fa-book fa-3x text-success"></i>
            </div>
            <h3 class="mb-1">{{ kpis.total_courses|default:0 }}</h3>
            <p class="text-muted mb-2">Total cours</p>
            <div class="d-flex justify-content-center align-items-center">
                <small class="text-muted">
                    {% if selected_program %}{{ selected_program.name }}{% else %}tous programmes{% endif %}
                </small>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card-neumorphic text-center">
            <div class="mb-3">
                <i class="fas fa-percentage fa-3x text-info"></i>
            </div>
            <h3 class="mb-1">{{ kpis.global_coverage|default:0 }}%</h3>
            <p class="text-muted mb-2">Taux de couverture global</p>
            <div class="d-flex justify-content-center align-items-center">
                {% if kpis.global_coverage >= 80 %}
                    <span class="badge bg-success me-2">
                        <i class="fas fa-check"></i> Excellent
                    </span>
                {% elif kpis.global_coverage >= 60 %}
                    <span class="badge bg-warning me-2">
                        <i class="fas fa-exclamation"></i> Moyen
                    </span>
                {% else %}
                    <span class="badge bg-danger me-2">
                        <i class="fas fa-times"></i> Faible
                    </span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card-neumorphic text-center">
            <div class="mb-3">
                <i class="fas fa-calendar-alt fa-3x text-warning"></i>
            </div>
            <h3 class="mb-1">{{ kpis.total_sessions|default:0 }}</h3>
            <p class="text-muted mb-2">Séances programmées</p>
            <div class="d-flex justify-content-center align-items-center">
                <small class="text-muted">{{ current_year.name }}</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- État d'avancement des cours -->
    <div class="col-lg-8 mb-4">
        <div class="card-neumorphic">
            <h5 class="mb-4">
                <i class="fas fa-chart-line me-2"></i>
                État d'avancement des cours
            </h5>

            {% if monitoring_stats.total_entries > 0 %}
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-2">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                            </div>
                            <h4 class="text-success">{{ monitoring_stats.status_distribution.termine }}</h4>
                            <p class="text-muted mb-0">Cours terminés</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-2">
                                <i class="fas fa-clock fa-2x text-warning"></i>
                            </div>
                            <h4 class="text-warning">{{ monitoring_stats.status_distribution.en_cours }}</h4>
                            <p class="text-muted mb-0">En cours</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-2">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            </div>
                            <h4 class="text-danger">{{ monitoring_stats.status_distribution.retard }}</h4>
                            <p class="text-muted mb-0">En retard</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container" id="statusChart" style="height: 200px;">
                    <canvas id="statusChartCanvas"></canvas>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>Aucune donnée de suivi disponible</p>
                    <small>Ajoutez des entrées de suivi pour voir les statistiques</small>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Activités pédagogiques -->
    <div class="col-lg-4 mb-4">
        <div class="card-neumorphic">
            <h5 class="mb-4">
                <i class="fas fa-tasks me-2"></i>
                Activités pédagogiques
            </h5>

            {% if monitoring_stats.total_entries > 0 %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Travaux préparatoires</span>
                        <span class="fw-bold">{{ monitoring_stats.pedagogical_activities.travaux_prep|default:0 }}%</span>
                    </div>
                    <div class="progress" style="height: 10px; border-radius: 10px; background-color: #e9ecef;">
                        <div class="progress-bar bg-primary"
                             style="width: {{ monitoring_stats.pedagogical_activities.travaux_prep|floatformat:0 }}%;
                                    border-radius: 10px;
                                    min-width: {% if monitoring_stats.pedagogical_activities.travaux_prep > 0 %}2px{% else %}0{% endif %};">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Travaux en équipe</span>
                        <span class="fw-bold">{{ monitoring_stats.pedagogical_activities.group_work|default:0 }}%</span>
                    </div>
                    <div class="progress" style="height: 10px; border-radius: 10px; background-color: #e9ecef;">
                        <div class="progress-bar bg-success"
                             style="width: {{ monitoring_stats.pedagogical_activities.group_work|floatformat:0 }}%;
                                    border-radius: 10px;
                                    min-width: {% if monitoring_stats.pedagogical_activities.group_work > 0 %}2px{% else %}0{% endif %};">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Travaux en salle</span>
                        <span class="fw-bold">{{ monitoring_stats.pedagogical_activities.class_work|default:0 }}%</span>
                    </div>
                    <div class="progress" style="height: 10px; border-radius: 10px; background-color: #e9ecef;">
                        <div class="progress-bar bg-info"
                             style="width: {{ monitoring_stats.pedagogical_activities.class_work|floatformat:0 }}%;
                                    border-radius: 10px;
                                    min-width: {% if monitoring_stats.pedagogical_activities.class_work > 0 %}2px{% else %}0{% endif %};">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>TD et TP</span>
                        <span class="fw-bold">{{ monitoring_stats.pedagogical_activities.td_tp|default:0 }}%</span>
                    </div>
                    <div class="progress" style="height: 10px; border-radius: 10px; background-color: #e9ecef;">
                        <div class="progress-bar bg-warning"
                             style="width: {{ monitoring_stats.pedagogical_activities.td_tp|floatformat:0 }}%;
                                    border-radius: 10px;
                                    min-width: {% if monitoring_stats.pedagogical_activities.td_tp > 0 %}2px{% else %}0{% endif %};">
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-tasks fa-2x mb-3"></i>
                    <p>Aucune donnée d'activité</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Évaluation des enseignants -->
    <div class="col-lg-8 mb-4">
        <div class="card-neumorphic">
            <h5 class="mb-4">
                <i class="fas fa-star me-2"></i>
                Évaluation des enseignants
            </h5>

            {% if evaluation_stats.total_evaluations > 0 %}
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-2">
                                <i class="fas fa-thumbs-up fa-2x text-success"></i>
                            </div>
                            <h4 class="text-success">{{ evaluation_stats.satisfaction_score }}%</h4>
                            <p class="text-muted mb-0">Satisfaction globale</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-2">
                                <i class="fas fa-users fa-2x text-info"></i>
                            </div>
                            <h4 class="text-info">{{ evaluation_stats.total_evaluations }}</h4>
                            <p class="text-muted mb-0">Évaluations</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-2">
                                <i class="fas fa-exclamation-circle fa-2x text-warning"></i>
                            </div>
                            <h4 class="text-warning">{{ evaluation_stats.stats.difficultes }}%</h4>
                            <p class="text-muted mb-0">Difficultés signalées</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container" id="evaluationChart" style="height: 200px;">
                    <canvas id="evaluationChartCanvas"></canvas>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-star fa-3x mb-3"></i>
                    <p>Aucune évaluation disponible</p>
                    <small>Les évaluations apparaîtront ici une fois saisies</small>
                </div>
            {% endif %}
        </div>
    </div>

    
</div>

<div class="row">
    <!-- Etat de couverture des cours par niveau -->
    <div class="col-lg-6 mb-4">
        <div class="card-neumorphic">
            <h5 class="mb-4">
                <i class="fas fa-layer-group me-2"></i>
                Couverture des cours par niveau
            </h5>

            <div class="table-responsive">
                <table class="table table-sm">
                    <tbody>
                        {% if levels_by_program %}
                            {% for program, levels in levels_by_program.items %}
                                <tr>
                                    <td colspan="4" style="text-align:center; font-weight:bold;">{{ program.name }}</td>
                                </tr>
                                <tr>
                                    <th>Niveau</th>
                                    <th>Cours</th>
                                    <th>Taux de couverture</th>
                                    <th>Moyenne</th>
                                </tr>

                                {% for level_stat in levels %}
                                    <tr>
                                        <td><span class="badge bg-primary">{{ level_stat.level.name }}</span></td>
                                        <td>{{ level_stat.course_count }}</td>
                                        <td>
                                            {% if level_stat.coverage >= 80 %}
                                                <span class="text-success fw-bold">{{ level_stat.coverage }}%</span>
                                            {% elif level_stat.coverage >= 60 %}
                                                <span class="text-warning fw-bold">{{ level_stat.coverage }}%</span>
                                            {% else %}
                                                <span class="text-danger fw-bold">{{ level_stat.coverage }}%</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ level_stat.avg_score }}</td>
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                                        <p>Aucune donnée de couverture disponible</p>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Trends 
    <div class="col-lg-6 mb-4">
        <div class="card-neumorphic">
            <h5 class="mb-4">
                <i class="fas fa-trending-up me-2"></i>
                Tendances récentes
            </h5>
            <div class="list-group list-group-flush">
                <div class="list-group-item border-0 bg-transparent">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success text-white rounded-circle p-2">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Augmentation des inscriptions</h6>
                            <p class="mb-0 text-muted">+15% par rapport au mois dernier</p>
                        </div>
                    </div>
                </div>
                
                <div class="list-group-item border-0 bg-transparent">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary text-white rounded-circle p-2">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Amélioration des résultats</h6>
                            <p class="mb-0 text-muted">Taux de réussite en hausse de 3%</p>
                        </div>
                    </div>
                </div>
                
                <div class="list-group-item border-0 bg-transparent">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info text-white rounded-circle p-2">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Nouveau programme populaire</h6>
                            <p class="mb-0 text-muted">Marketing digital en forte demande</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Graphique de statut d'avancement
    {% if monitoring_stats.total_entries > 0 %}
    const statusCtx = document.getElementById('statusChartCanvas');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Terminés', 'En cours', 'En retard'],
                datasets: [{
                    data: [
                        {{ monitoring_stats.status_distribution.termine }},
                        {{ monitoring_stats.status_distribution.en_cours }},
                        {{ monitoring_stats.status_distribution.retard }}
                    ],
                    backgroundColor: [
                        '#28a745',
                        '#ffc107',
                        '#dc3545'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    // Graphique d'évaluation
    {% if evaluation_stats.total_evaluations > 0 %}
    const evalCtx = document.getElementById('evaluationChartCanvas');
    if (evalCtx) {
        new Chart(evalCtx, {
            type: 'bar',
            data: {
                labels: [
                    'Support accessible',
                    'Bonne explication',
                    'Bonne réponse',
                    'Donne TD',
                    'Donne projets'
                ],
                datasets: [{
                    label: 'Pourcentage positif',
                    data: [
                        {{ evaluation_stats.stats.support_accessible }},
                        {{ evaluation_stats.stats.bonne_explication }},
                        {{ evaluation_stats.stats.bonne_reponse }},
                        {{ evaluation_stats.stats.donne_td }},
                        {{ evaluation_stats.stats.donne_projet }}
                    ],
                    backgroundColor: [
                        '#007bff',
                        '#28a745',
                        '#17a2b8',
                        '#ffc107',
                        '#6f42c1'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    .form-select {
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,0.1);
        background: var(--primary-color);
        box-shadow: inset 2px 2px 5px #b8b9be, inset -2px -2px 5px #fff;
    }
    
    .form-select:focus {
        border-color: var(--accent-color);
        box-shadow: inset 2px 2px 5px #b8b9be, inset -2px -2px 5px #fff, 0 0 0 0.2rem rgba(38, 40, 51, 0.25);
    }
    
    .progress {
        background: #e9ecef !important;
        box-shadow: inset 2px 2px 5px #b8b9be, inset -2px -2px 5px #fff;
        border: 1px solid rgba(0,0,0,0.1);
    }

    .progress-bar {
        transition: width 0.6s ease;
        box-shadow: none;
    }

    .progress-bar.bg-primary {
        background-color: #007bff !important;
    }

    .progress-bar.bg-success {
        background-color: #28a745 !important;
    }

    .progress-bar.bg-info {
        background-color: #17a2b8 !important;
    }

    .progress-bar.bg-warning {
        background-color: #ffc107 !important;
    }
    
    .table {
        background: transparent;
    }
    
    .table th {
        border-top: none;
        border-bottom: 2px solid rgba(0,0,0,0.1);
        font-weight: 600;
        color: var(--text-color);
    }
    
    .table td {
        border-top: 1px solid rgba(0,0,0,0.05);
        vertical-align: middle;
    }
    
    .badge {
        border-radius: 20px;
        padding: 0.4em 0.8em;
    }
    
    .list-group-item {
        padding: 1rem 0;
    }
    
    .list-group-item:not(:last-child) {
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    .chart-container {
        position: relative;
    }
</style>
{% endblock %}
