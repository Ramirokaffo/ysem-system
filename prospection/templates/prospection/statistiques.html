{% extends 'prospection/base.html' %}

{% load static %}

{% block title %}Statistiques de Prospection - YSEM{% endblock %}

{% block page_title %}Statistiques de Prospection{% endblock %}

{% block breadcrumb_title %}Statistiques{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button class="btn btn-neumorphic" onclick="window.print()">
        <i class="fas fa-print me-2"></i>
        Imprimer
    </button>
    <a href="{% url 'prospection:dashboard' %}" class="btn btn-neumorphic">
        <i class="fas fa-tachometer-alt me-2"></i>
        Dashboard
    </a>
</div>
{% endblock %}

{% block prospection_content %}
<!-- Statistiques g√©n√©rales -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card-neumorphic shadow-inset">
            <h5 class="mb-4 border-bottom pb-2">
                <i class="fas fa-chart-pie me-2"></i>
                Vue d'ensemble
            </h5>
            
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="text-center shadow-inset card p-2">
                        <div class="stat-icon danger mb-2">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <h3 class="mb-0">{{ stats_generales.total_agents }}</h3>
                        <p class="text-muted mb-0">Agents total</p>
                        <small class="text-success">{{ stats_generales.agents_actifs }} actifs</small>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="text-center shadow-inset card p-2">
                        <div class="stat-icon warning mb-2">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        <h3 class="mb-0">{{ stats_generales.total_campagnes }}</h3>
                        <p class="text-muted mb-0">Campagnes total</p>
                        <small class="text-success">{{ stats_generales.campagnes_actives }} actives</small>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="text-center shadow-inset card p-2">
                        <div class="stat-icon info mb-2">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 class="mb-0">{{ stats_generales.total_equipes }}</h3>
                        <p class="text-muted mb-0">√âquipes form√©es</p>
                        <small class="text-muted">Toutes campagnes</small>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="text-center shadow-inset card p-2">
                        <div class="stat-icon success mb-2">
                            <i class="fas fa-address-book"></i>
                        </div>
                        <h3 class="mb-0">{{ stats_generales.total_prospects }}</h3>
                        <p class="text-muted mb-0">Prospects collect√©s</p>
                        <small class="text-muted">Total g√©n√©ral</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistiques par campagne -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card-neumorphic shadow-inset">
            <h5 class="mb-4 border-bottom pb-2">
                <i class="fas fa-chart-bar me-2"></i>
                Performance par campagne
            </h5>
            
            {% if stats_campagnes %}
            <div class="table-responsive">
                <table class="table table-borderless">
                    <thead>
                        <tr>
                            <th>Campagne</th>
                            <th>Ann√©e acad√©mique</th>
                            <th>Statut</th>
                            <th>√âquipes</th>
                            <th>Objectif</th>
                            <th>Collect√©s</th>
                            <th>Taux</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for campagne in stats_campagnes %}
                        <tr>
                            <td>
                                <a href="{% url 'prospection:detail_campagne' campagne.pk %}" class="text-decoration-none">
                                    {{ campagne.nom }}
                                </a>
                            </td>
                            <td>{{ campagne.annee_academique }}</td>
                            <td>
                                <span class="badge badge-{% if campagne.statut == 'en_cours' %}success{% elif campagne.statut == 'planifiee' %}warning{% elif campagne.statut == 'terminee' %}secondary{% else %}danger{% endif %}">
                                    {{ campagne.get_statut_display }}
                                </span>
                            </td>
                            <td>{{ campagne.equipes_count }}</td>
                            <td>{{ campagne.objectif_global }}</td>
                            <td>{{ campagne.prospects_count }}</td>
                            <td>
                                {% widthratio campagne.prospects_count campagne.objectif_global 100 as taux %}
                                <span class="badge badge-{% if taux >= 100 %}success{% elif taux >= 75 %}warning{% else %}danger{% endif %}">
                                    {{ taux|default:0 }}%
                                </span>
                            </td>
                            <td>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar {% if taux >= 100 %}bg-success{% elif taux >= 75 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         role="progressbar" 
                                         style="width: {% if taux > 100 %}100{% else %}{{ taux|default:0 }}{% endif %}%">
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-chart-bar fa-2x text-muted mb-2"></i>
                <p class="text-muted">Aucune campagne disponible pour les statistiques</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <!-- Top agents collecteurs -->
    <div class="col-lg-6 mb-4">
        <div class="card-neumorphic shadow-inset">
            <h5 class="mb-4 border-bottom pb-2">
                <i class="fas fa-trophy me-2"></i>
                Top agents collecteurs
            </h5>
            
            {% if top_agents %}
            <div class="list-group list-group-flush">
                {% for agent in top_agents %}
                <div class="list-group-item border-0 bg-transparent">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3 mr-2">
                            <div class="stat-icon {% if forloop.first %}success{% elif forloop.counter <= 3 %}warning{% else %}secondary{% endif %}">
                                <i class="fas fa-{% if forloop.first %}crown{% elif forloop.counter <= 3 %}medal{% else %}user{% endif %}"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <a href="{% url 'prospection:detail_agent' agent.matricule %}" class="text-decoration-none">
                                    {{ agent.nom_complet }}
                                </a>
                                {% if forloop.first %}
                                    <span class="badge badge-success ms-2">ü•á</span>
                                {% elif forloop.counter == 2 %}
                                    <span class="badge badge-warning ms-2">ü•à</span>
                                {% elif forloop.counter == 3 %}
                                    <span class="badge badge-info ms-2">ü•â</span>
                                {% endif %}
                            </h6>
                            <p class="mb-0 text-muted">{{ agent.matricule }} - {{ agent.get_type_agent_display }}</p>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="badge badge-danger">{{ agent.prospects_count }} prospects</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-users fa-2x text-muted mb-2"></i>
                <p class="text-muted">Aucun agent n'a encore collect√© de prospects</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Top √©quipes performantes -->
    <div class="col-lg-6 mb-4">
        <div class="card-neumorphic shadow-inset">
            <h5 class="mb-4 border-bottom pb-2">
                <i class="fas fa-users me-2"></i>
                Top √©quipes performantes
            </h5>
            
            {% if top_equipes %}
            <div class="list-group list-group-flush">
                {% for equipe in top_equipes %}
                <div class="list-group-item border-0 bg-transparent">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3 mr-2">
                            <div class="stat-icon {% if forloop.first %}success{% elif forloop.counter <= 3 %}warning{% else %}secondary{% endif %}">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <a href="{% url 'prospection:detail_equipe' equipe.pk %}" class="text-decoration-none">
                                    {{ equipe.nom }}
                                </a>
                                {% if forloop.first %}
                                    <span class="badge badge-success ms-2">üèÜ</span>
                                {% endif %}
                            </h6>
                            <p class="mb-0 text-muted">{{ equipe.campagne.nom|truncatechars:30 }}</p>
                            <small class="text-muted">{{ equipe.prospects_count }}/{{ equipe.objectif_prospects }} prospects</small>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="badge badge-{% if equipe.taux_realisation >= 100 %}success{% elif equipe.taux_realisation >= 75 %}warning{% else %}danger{% endif %}">
                                {{ equipe.taux_realisation|floatformat:1 }}%
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-users fa-2x text-muted mb-2"></i>
                <p class="text-muted">Aucune √©quipe n'a encore collect√© de prospects</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Graphiques et analyses -->
<div class="row mb-4">
    <!-- Graphique prospects par campagne -->
    <div class="col-lg-6 mb-4">
        <div class="card-neumorphic shadow-inset">
            <h5 class="mb-4 border-bottom pb-2">
                <i class="fas fa-chart-bar me-2"></i>
                Prospects par campagne
            </h5>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="campaignChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Graphique √©volution des prospects -->
    <div class="col-lg-6 mb-4">
        <div class="card-neumorphic shadow-inset">
            <h5 class="mb-4 border-bottom pb-2">
                <i class="fas fa-chart-line me-2"></i>
                √âvolution des prospects (6 derniers mois)
            </h5>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="evolutionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Graphique r√©partition des agents -->
    <div class="col-lg-6 mb-4">
        <div class="card-neumorphic shadow-inset">
            <h5 class="mb-4 border-bottom pb-2">
                <i class="fas fa-chart-pie me-2"></i>
                R√©partition des agents par type
            </h5>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="agentsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Graphique performance des √©quipes -->
    <div class="col-lg-6 mb-4">
        <div class="card-neumorphic shadow-inset">
            <h5 class="mb-4 border-bottom pb-2">
                <i class="fas fa-chart-radar me-2"></i>
                Performance des meilleures √©quipes
            </h5>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- R√©sum√© et recommandations -->
<div class="row">
    <div class="col-12">
        <div class="card-neumorphic shadow-inset">
            <h5 class="mb-4 border-bottom pb-2">
                <i class="fas fa-lightbulb me-2"></i>
                R√©sum√© et recommandations
            </h5>

            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted">Points forts</h6>
                    <ul class="list-unstyled">
                        {% if stats_generales.agents_actifs > 0 %}
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            {{ stats_generales.agents_actifs }} agents actifs disponibles
                        </li>
                        {% endif %}
                        {% if stats_generales.campagnes_actives > 0 %}
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            {{ stats_generales.campagnes_actives }} campagne{{ stats_generales.campagnes_actives|pluralize }} en cours
                        </li>
                        {% endif %}
                        {% if stats_generales.total_prospects > 0 %}
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            {{ stats_generales.total_prospects }} prospects d√©j√† collect√©s
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <div class="col-md-6">
                    <h6 class="text-muted">Recommandations</h6>
                    <ul class="list-unstyled">
                        {% if stats_generales.campagnes_actives == 0 %}
                        <li class="mb-2">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Aucune campagne active - <a href="{% url 'prospection:ajouter_campagne' %}">cr√©er une campagne</a>
                        </li>
                        {% endif %}
                        {% if stats_generales.total_equipes == 0 %}
                        <li class="mb-2">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Aucune √©quipe form√©e - <a href="{% url 'prospection:ajouter_equipe' %}">former des √©quipes</a>
                        </li>
                        {% endif %}
                        {% if stats_generales.agents_actifs < 4 %}
                        <li class="mb-2">
                            <i class="fas fa-info-circle text-info me-2"></i>
                            Recruter plus d'agents pour optimiser la prospection
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuration des couleurs
    const colors = {
        primary: '#6366f1',
        success: '#10b981',
        warning: '#f59e0b',
        danger: '#ef4444',
        info: '#3b82f6',
        secondary: '#6b7280'
    };

    // 1. Graphique prospects par campagne
    const campaignCtx = document.getElementById('campaignChart').getContext('2d');
    const campaignData = JSON.parse('{{ campagnes_prospects_data|escapejs }}');

    new Chart(campaignCtx, {
        type: 'bar',
        data: {
            labels: campaignData.map(item => item.nom),
            datasets: [{
                label: 'Prospects collect√©s',
                data: campaignData.map(item => item.prospects),
                backgroundColor: colors.primary,
                borderColor: colors.primary,
                borderWidth: 1
            }, {
                label: 'Objectif',
                data: campaignData.map(item => item.objectif),
                backgroundColor: colors.warning,
                borderColor: colors.warning,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 2. Graphique √©volution des prospects
    const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
    const evolutionData = JSON.parse('{{ prospects_evolution_data|escapejs }}');

    new Chart(evolutionCtx, {
        type: 'line',
        data: {
            labels: evolutionData.map(item => {
                const date = new Date(item.mois);
                return date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            }),
            datasets: [{
                label: 'Prospects collect√©s',
                data: evolutionData.map(item => item.count),
                borderColor: colors.success,
                backgroundColor: colors.success + '20',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 3. Graphique r√©partition des agents
    const agentsCtx = document.getElementById('agentsChart').getContext('2d');
    const agentsData = JSON.parse('{{ agents_type_data|escapejs }}');

    new Chart(agentsCtx, {
        type: 'doughnut',
        data: {
            labels: agentsData.map(item => {
                const types = {
                    'junior': 'Junior',
                    'senior': 'Senior',
                    'lead': 'Lead'
                };
                return types[item.type_agent] || item.type_agent;
            }),
            datasets: [{
                data: agentsData.map(item => item.count),
                backgroundColor: [colors.primary, colors.success, colors.warning, colors.danger, colors.info],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

    // 4. Graphique performance des √©quipes
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    const performanceData = JSON.parse('{{ equipes_performance_data|escapejs }}');

    new Chart(performanceCtx, {
        type: 'bar',
        data: {
            labels: performanceData.map(item => item.nom.length > 20 ? item.nom.substring(0, 20) + '...' : item.nom),
            datasets: [{
                label: 'Taux de r√©alisation (%)',
                data: performanceData.map(item => item.taux),
                backgroundColor: performanceData.map(item => {
                    if (item.taux >= 100) return colors.success;
                    if (item.taux >= 75) return colors.warning;
                    return colors.danger;
                }),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 120
                }
            }
        }
    });
});
</script>
{% endblock %}
